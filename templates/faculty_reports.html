{% extends 'base.html' %}

{% block title %}Faculty Reports - MGMU IQAC{% endblock %}

{% block content %}
<h2>Teaching Skills Reports</h2>
<div style="margin-top:12px; max-width:800px;">
    {% if session.role == 'faculty' %}
        <form method="POST" class="form-box">
            <label for="report_title">Report Title *</label>
            <input id="report_title" name="report_title" placeholder="Report Title" required />

            <label for="report_content">Report Content *</label>
            <textarea id="report_content" name="report_content" rows="6" placeholder="Details about teaching skills, feedback, etc." required></textarea>

            <div style="margin-top:12px;"><button type="submit">Add Report</button></div>
        </form>
    {% endif %}

    <div style="margin-top:18px;">
        <h3>Existing Reports</h3>
        {% if reports %}
            <ul>
                {% for report in reports %}
                    <li style="margin-bottom:12px; padding:8px; border:1px solid #ddd;">
                        <strong>{{ report.title }}</strong> ({{ report.date }}) - <span style="color: {% if report.status == 'approved' %}green{% elif report.status == 'rejected' %}red{% else %}orange{% endif %};">{{ report.status|title }}</span>
                        <p>{{ report.content }}</p>
                        {% if report.auditor_notes %}
                            <p><em>Auditor Notes: {{ report.auditor_notes }}</em></p>
                        {% endif %}

                        {# Approvals summary for required approvers #}
                        <div style="margin-top:8px; border-top:1px solid #eee; padding-top:8px;">
                            <strong>Approvals:</strong>
                            <ul>
                                {% for r in required_approvers %}
                                    {% set apr = (report.approvals or {}).get(r) %}
                                    <li>
                                        <strong>{{ ROLE_DISPLAY.get(r, r) }}:</strong>
                                        {% if apr %}
                                            <span style="color: {% if apr.decision == 'approved' %}green{% else %}red{% endif %};">{{ apr.decision|title }}</span>
                                            {% if apr.notes %}
                                                - <em>{{ apr.notes }}</em>
                                            {% endif %}
                                        {% else %}
                                            <span style="color:orange;">Pending</span>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>

                            {# If current user is one of the required approvers and hasn't acted yet, show the approve/reject form #}
                            {% if session.role in required_approvers %}
                                {% if (not report.approvals) or (session.role not in report.approvals) %}
                                    <form method="POST" style="margin-top:8px;">
                                        <input type="hidden" name="report_index" value="{{ loop.index0 }}">
                                        <label>{{ ROLE_DISPLAY.get(session.role, session.role) }} Notes (optional)</label>
                                        <textarea name="approver_notes" rows="2"></textarea>
                                        <div style="margin-top:6px;">
                                            <button type="submit" name="action" value="approve">Approve</button>
                                            <button type="submit" name="action" value="reject">Reject</button>
                                        </div>
                                    </form>
                                {% else %}
                                    <p style="margin-top:6px;"><em>You have already submitted your decision.</em></p>
                                {% endif %}
                            {% endif %}
                        </div>

                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p><em>No reports yet.</em></p>
        {% endif %}
    </div>
</div>
{% endblock %}